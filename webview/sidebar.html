<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salesforce Object Explorer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background: #f8f9fa; }
    .card { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
    .table { width: 100%; }
    .table th, .table td { text-align: left; }
    .card-header { font-size: 18px; background-color: #28a745; color: white; padding: 15px; }
    .card-body { padding: 15px; }
    .field-reference-master { background-color: #ffeb3b; }
    .field-reference-lookup { background-color: #cce5ff; }
    .field-details { margin-top: 20px; display: none; background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd; }
    .search-fields { margin-top: 15px; }
    .section-header { font-size: 18px; color: #007bff; margin-top: 30px; }
    .record-types, .page-layouts, .soql-query { margin-top: 20px; }
    .search-field-card { padding: 15px; background: #e9ecef; margin-top: 15px; border-radius: 8px; }
    .search-field-card input { width: 100%; }
    .field-checkbox { margin-right: 10px; }
    .user-org-info { font-size: 14px; color: #555; margin-bottom: 15px; }
    .query-hint { font-size: 12px; color: #666; margin-top: 5px; }
    .relationship-section { margin-top: 15px; padding: 10px; background: #f1f1f1; border-radius: 6px; }
    .relationship-table th, .relationship-table td { padding: 5px; }
  </style>
</head>
<body>
  <div id="userOrgInfo" class="user-org-info"></div>

  <div class="mb-3">
    <label for="objectSearch" class="form-label">Search for Object (Name or API Name):</label>
    <input type="text" id="objectSearch" class="form-control" oninput="onSearchInput()" placeholder="Enter Object Name or API Name...">
    <div id="objectSuggestions" class="list-group" style="position: absolute; z-index: 999; width: 100%; max-height: 200px; overflow-y: auto;"></div>
  </div>

  <div id="objectContainer"></div>

  <div id="fieldDetails" class="field-details"></div>

  <div class="record-types">
    <h5 class="section-header">Record Types</h5>
    <div id="recordTypes"></div>
  </div>

  <div class="page-layouts">
    <h5 class="section-header">Page Layouts</h5>
    <div id="pageLayouts"></div>
  </div>

  <div class="soql-query">
    <h5 class="section-header">SOQL Query</h5>
    <div class="mb-2">
      <button class="btn btn-primary" onclick="toggleFieldSelector()">Build Query</button>
      <div id="fieldSelector" class="mt-2" style="display: none;">
        <h6>Select Fields:</h6>
        <div id="fieldCheckboxes" class="mb-2"></div>
        <button class="btn btn-success btn-sm" onclick="buildSOQLQuery()">Generate Query</button>
      </div>
    </div>
    <textarea id="soqlQuery" class="form-control" rows="3" placeholder="Enter or generate SOQL Query here..."></textarea>
    <div class="query-hint">
      Hint: Use parent fields (e.g., CreatedBy.Name) or subqueries (e.g., (SELECT Id FROM Opportunities)) for relationship/nested queries.
    </div>
    <button class="btn btn-primary mt-2" onclick="runQuery()">Run Query</button>
  </div>

  <div id="soqlResults" class="mt-3"></div>

  <script>
    const vscode = acquireVsCodeApi();
    let currentData = null;
    let allFields = [];

    function onSearchInput() {
      const val = document.getElementById('objectSearch').value.toLowerCase().trim();
      const suggestionBox = document.getElementById('objectSuggestions');
      suggestionBox.innerHTML = '';
      if (!val) return suggestionBox.style.display = 'none';

      const matches = window.__objects?.filter(o => 
        o.label.toLowerCase().includes(val) || o.apiName.toLowerCase().includes(val)
      ).slice(0, 10);
      matches.forEach(obj => {
        const div = document.createElement('div');
        div.className = 'list-group-item list-group-item-action';
        div.textContent = `${obj.label} (${obj.apiName})`;
        div.onclick = () => {
          document.getElementById('objectSearch').value = obj.apiName;
          suggestionBox.style.display = 'none';
          vscode.postMessage({ command: 'selectObject', objectName: obj.apiName });
        };
        suggestionBox.appendChild(div);
      });
      suggestionBox.style.display = matches.length ? 'block' : 'none';
    }

    function renderGraph(data) {
      currentData = data;
      allFields = data.fields;
      document.getElementById('fieldDetails').style.display = 'none';

      renderObjectCard(data);
      renderRecordTypes(data);
      renderPageLayouts(data);
      document.getElementById('soqlResults').innerHTML = '';
      renderFieldSelector(data);
    }

    function getFieldType(field) {
      if (field.type === 'reference') {
        return field.relationshipName ? 'Master-Detail' : 'Lookup';
      }
      return field.custom ? 'Custom' : 'Standard';
    }

    function renderObjectCard(data) {
      const objectContainer = document.getElementById('objectContainer');
      const parentRelationships = data.fields.filter(f => f.type === 'reference' && f.referenceTo.length > 0);
      const childRelationships = data.childRelationships.filter(cr => cr.relationshipName);

      objectContainer.innerHTML = `
        <div class="card">
          <div class="card-header">${data.label} (API Name: ${data.apiName})</div>
          <div class="card-body">
            <h5>Fields</h5>
            <div class="search-field-card">
              <h6>Search Fields</h6>
              <input type="text" class="form-control" placeholder="Search field..." oninput="filterFieldTable(this.value)">
            </div>
            <table class="table table-bordered" id="fieldTable">
              <thead>
                <tr><th>Field Name</th><th>API Name</th><th>Type</th><th>Required</th><th>References</th><th>Field Type</th></tr>
              </thead>
              <tbody>
                ${data.fields.map(field => `
                  <tr class="${field.type === 'reference' ? (field.relationshipName ? 'field-reference-master' : 'field-reference-lookup') : ''}">
                    <td>${field.label}</td>
                    <td>${field.apiName}</td>
                    <td>${field.type}</td>
                    <td>${field.required ? 'Yes' : 'No'}</td>
                    <td>${field.type === 'reference' ? field.referenceTo.join(', ') : 'N/A'}</td>
                    <td>${getFieldType(field)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="relationship-section">
              <h6>Parent Relationships (e.g., CreatedBy.Name)</h6>
              ${parentRelationships.length ? `
                <table class="table table-bordered relationship-table">
                  <thead><tr><th>Field API Name</th><th>Relationship Name</th><th>References To</th></tr></thead>
                  <tbody>
                    ${parentRelationships.map(f => `
                      <tr>
                        <td>${f.apiName}</td>
                        <td>${f.relationshipName || 'N/A'}</td>
                        <td>${f.referenceTo.join(', ')}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              ` : '<p>No parent relationships found.</p>'}
            </div>

            <div class="relationship-section">
              <h6>Child Relationships (e.g., (SELECT Id FROM Opportunities))</h6>
              ${childRelationships.length ? `
                <table class="table table-bordered relationship-table">
                  <thead><tr><th>Child Object</th><th>Relationship Name</th><th>Linking Field</th></tr></thead>
                  <tbody>
                    ${childRelationships.map(cr => `
                      <tr>
                        <td>${cr.childSObject}</td>
                        <td>${cr.relationshipName}</td>
                        <td>${cr.field}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              ` : '<p>No child relationships found.</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function filterFieldTable(val) {
      const filtered = allFields.filter(f => f.label.toLowerCase().includes(val.toLowerCase()) || f.apiName.toLowerCase().includes(val.toLowerCase()));
      const tbody = document.querySelector('#fieldTable tbody');
      tbody.innerHTML = filtered.map(field => `
        <tr class="${field.type === 'reference' ? (field.relationshipName ? 'field-reference-master' : 'field-reference-lookup') : ''}">
          <td>${field.label}</td>
          <td>${field.apiName}</td>
          <td>${field.type}</td>
          <td>${field.required ? 'Yes' : 'No'}</td>
          <td>${field.type === 'reference' ? field.referenceTo.join(', ') : 'N/A'}</td>
          <td>${getFieldType(field)}</td>
        </tr>
      `).join('');
    }

    function renderRecordTypes(data) {
      document.getElementById('recordTypes').innerHTML = data.recordTypes.length ? `
        <table class="table table-bordered">
          <thead><tr><th>Record Type Name</th><th>API Name</th></tr></thead>
          <tbody>${data.recordTypes.map(rt => `<tr><td>${rt.label}</td><td>${rt.apiName}</td></tr>`).join('')}</tbody>
        </table>
      ` : '<p>No record types found.</p>';
    }

    function renderPageLayouts(data) {
      document.getElementById('pageLayouts').innerHTML = data.pageLayouts.length ? `
        <table class="table table-bordered">
          <thead><tr><th>Page Layout Name</th><th>API Name</th></tr></thead>
          <tbody>${data.pageLayouts.map(pl => `<tr><td>${pl.label}</td><td>${pl.apiName}</td></tr>`).join('')}</tbody>
        </table>
      ` : '<p>No page layouts found.</p>';
    }

    function toggleFieldSelector() {
      const selector = document.getElementById('fieldSelector');
      selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
    }

    function renderFieldSelector(data) {
      const fieldCheckboxes = document.getElementById('fieldCheckboxes');
      fieldCheckboxes.innerHTML = data.fields.map(field => `
        <div>
          <input type="checkbox" class="field-checkbox" value="${field.apiName}" id="field_${field.apiName}">
          <label for="field_${field.apiName}">${field.label} (${field.apiName})</label>
        </div>
      `).join('');
    }

    function buildSOQLQuery() {
      const selectedFields = Array.from(document.querySelectorAll('#fieldCheckboxes input:checked')).map(input => input.value);
      if (selectedFields.length === 0) {
        alert('Please select at least one field.');
        return;
      }
      const query = `SELECT ${selectedFields.join(', ')} FROM ${currentData.apiName} LIMIT 100`;
      document.getElementById('soqlQuery').value = query;
      toggleFieldSelector();
    }

    function runQuery() {
      const query = document.getElementById('soqlQuery').value.trim();
      if (!query) {
        alert('Please enter a SOQL query.');
        return;
      }
      vscode.postMessage({ command: 'runSOQLQuery', query });
    }

    function flattenValue(value) {
      if (value === null || value === undefined) return '';
      if (typeof value === 'object' && 'records' in value) {
        return value.records.map(r => {
          const fields = Object.keys(r).filter(k => k !== 'attributes');
          return fields.length > 0 ? r[fields[0]] : JSON.stringify(r);
        }).join(', ');
      }
      if (typeof value === 'object') {
        const fields = Object.keys(value).filter(k => k !== 'attributes');
        return value.Name || (fields.length > 0 ? value[fields[0]] : JSON.stringify(value));
      }
      return value.toString();
    }

    function renderSOQLResults(results) {
      if (!results || results.length === 0) {
        document.getElementById('soqlResults').innerHTML = '<p>No results found.</p>';
        return;
      }
      const headers = Object.keys(results[0]).filter(k => k !== 'attributes');
      document.getElementById('soqlResults').innerHTML = `
        <h5 class="section-header">Query Results</h5>
        <table class="table table-bordered">
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>
            ${results.map(row => `
              <tr>${headers.map(h => `<td>${flattenValue(row[h])}</td>`).join('')}</tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    window.addEventListener('message', event => {
      const message = event.data;
      if (message.command === 'loadObjects') {
        window.__objects = message.objects;
        document.getElementById('userOrgInfo').innerHTML = `Logged in as: ${message.userName} | Org: ${message.orgName}`;
      } else if (message.command === 'displayMetadata') {
        renderGraph(message.data);
      } else if (message.command === 'displaySOQLResults') {
        renderSOQLResults(message.data);
      } else if (message.command === 'error') {
        document.getElementById('fieldDetails').innerHTML = `<div class="alert alert-danger">${message.message}</div>`;
        document.getElementById('fieldDetails').style.display = 'block';
      }
    });
  </script>
</body>
</html>